<meta charset="utf8">
<div id="parameters"></div>
<button onclick="addParameter()">Добавить параметр</button>
<br>
<textarea id = "expressionInputElement" style="width:100%; height:20%"></textarea>
<button  onclick = "computeButtonClicked()">Посчитать</button>

<p id = "resultTextElement"></p>

<script>
    function computeButtonClicked()
    {
        var textarea = document.getElementById("expressionInputElement");

        var parametersDiv = document.getElementById("parameters");
        var parameters = [];

        for (i = 0; i < parametersDiv.children.length; i++) {
            var child = parametersDiv.children[i];
            if (child.className != "parameter")
                continue;
            var variableName = "";
            var value = 0;
            for (j = 0; j < child.children.length; j++) {
                var subChild = child.children[j];
                if (subChild.className == "parameterNameInput")
                    variableName = subChild.value;
                else if(subChild.className == "parameterValueInput")
                    value = Number(subChild.value);
            }

            parameters.push({
                variableName: variableName,
                value: value
            });
        }

        requestfinished = function()
        {
            var resultTextElement = document.getElementById("resultTextElement");
            var responseObj = JSON.parse(this.responseText);
            if(this.status == 200)
            {
                resultTextElement.innerText = responseObj.result;
            }
            else
            {
                resultTextElement.innerText = "Ошибка! Ответ от сервера: " + responseObj.message;
            }
        };

        sendRequestToComputeExpression(textarea.value, parameters, requestfinished);
    }

    function sendRequestToComputeExpression(expression, parameters,  requestFinishedDelegate)
    {
        var xhr = new XMLHttpRequest();

        xhr.open("post", "/api/math/computeExpression", true);

        xhr.onload = requestFinishedDelegate;

        var payload = { expression: expression, parameters: parameters };

        payloadString = JSON.stringify(payload);
        xhr.setRequestHeader("content-type", "application/json");
        xhr.send(payloadString);
    }

    function addParameter()
    {
        var parametersDiv = document.getElementById("parameters");

        var parameterDiv = document.createElement("div");

        parameterDiv.className = "parameter";

        var span1 = document.createElement("span");
        span1.innerText = "Имя параметра:";
        parameterDiv.appendChild(span1);

        var nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "parameterNameInput";
        parameterDiv.appendChild(nameInput);

        parameterDiv.appendChild(document.createElement("br"));

        var span2 = document.createElement("span");
        span2.innerText = "Значение:";
        parameterDiv.appendChild(span2);

        var valueInput = document.createElement("input");
        valueInput.type = "text";
        valueInput.className = "parameterValueInput";
        parameterDiv.appendChild(valueInput);

        parametersDiv.appendChild(parameterDiv);
    }



</script>